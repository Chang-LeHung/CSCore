# OpenMP æ•™ç¨‹ï¼ˆä¸€ï¼‰â€”â€”OpenMP å½“ä¸­çš„æ•°æ®ç¯å¢ƒ

## å‰è¨€

åœ¨å‰é¢çš„æ•™ç¨‹[OpenMPå…¥é—¨](https://mp.weixin.qq.com/s?__biz=Mzg3ODgyNDgwNg==&mid=2247487188&idx=1&sn=474ac3ef08d47439af963ae4376647a4&chksm=cf0c92ddf87b1bcb969da565e65338829281c7ffc320f0669344dfc7b4fcd4ff7699c55eb1dd&token=1178892963&lang=zh_CN#rd)å½“ä¸­æˆ‘ä»¬ç®€è¦ä»‹ç»äº† OpenMP çš„ä¸€äº›åŸºç¡€çš„ä½¿ç”¨æ–¹æ³•ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬å°†ä»ä¸€äº›åŸºç¡€çš„é—®é¢˜é€æ¸ä»‹ç»åœ¨ OpenMP å½“ä¸­å’Œæ•°æ®çš„ç¯å¢ƒç›¸å…³çš„æŒ‡ä»¤å’Œå­å¥ã€‚

## ä»å¹¶å‘æ±‚å’Œå¼€å§‹

æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªå˜é‡ `data` è¿›è¡Œ `++`æ“ä½œï¼Œæ‰§è¡Œ 10000 æ¬¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼š

```c

#include <stdio.h>
#include <omp.h>
#include <unistd.h>

static int data;

int main() {
  #pragma omp parallel num_threads(2) // ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¸Šé¢çš„ä»£ç å—
  {
    for(int i = 0; i < 10000; i++) {
      data++;
      usleep(10);
    }
    // omp_get_thread_num å‡½æ•°è¿”å›çº¿ç¨‹çš„ id å· è¿™ä¸ªæ•°æ®ä» 0 å¼€å§‹ï¼Œ0, 1, 2, 3, 4, ...
    printf("data = %d tid = %d\n", data, omp_get_thread_num());
  }

  printf("In main function data = %d\n", data);
  return 0;
}
```

åœ¨ä¸Šé¢çš„ä»£ç å½“ä¸­ï¼Œæˆ‘ä»¬å¼€å¯äº†ä¸¤ä¸ªçº¿ç¨‹å¹¶ä¸”åŒæ—¶æ‰§è¡Œ `$pragma` ä¸‹é¢çš„ä»£ç å—ï¼Œä½†æ˜¯ä¸Šé¢çš„ç¨‹åºæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ‰§è¡Œ `data++` æ“ä½œï¼Œä½†æ˜¯åŒæ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œçš„è¯ï¼Œå°±å­˜åœ¨å¹¶å‘ç¨‹åºçš„æ•°æ®ç«äº‰é—®é¢˜ï¼Œåœ¨ OpenMP å½“ä¸­é»˜è®¤çš„æ•°æ®ä½¿ç”¨æ–¹å¼å°±æ˜¯ğŸ§â€â™‚ï¸çº¿ç¨‹ä¹‹é—´æ˜¯å…±äº«çš„æ¯”å¦‚ä¸‹é¢çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

- é¦–å…ˆçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 å°† data åŠ è½½åˆ° CPU ç¼“å­˜å½“ä¸­ï¼Œå½“å‰çš„ä¸¤ä¸ªçº¿ç¨‹å¾—åˆ°çš„ `data` çš„å€¼éƒ½æ˜¯ 0 ã€‚
- çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 å¯¹ `data` è¿›è¡Œ ++ æ“ä½œï¼Œç°åœ¨ä¸¤ä¸ªçº¿ç¨‹çš„ `data` çš„å€¼éƒ½æ˜¯ 1ã€‚
- çº¿ç¨‹ 1 å°† data çš„å€¼å†™å›åˆ°ä¸»å­˜å½“ä¸­ï¼Œé‚£ä¹ˆä¸»å­˜å½“ä¸­çš„æ•°æ®çš„å€¼å°±ç­‰äº 1 ã€‚
- çº¿ç¨‹ 2 å°† data çš„å€¼å†™å›åˆ°ä¸»å­˜å½“ä¸­ï¼Œé‚£ä¹ˆä¸»å­˜å½“ä¸­çš„æ•°æ®çš„å€¼ä¹Ÿç­‰äº 1 ã€‚

ä½†æ˜¯ä¸Šé¢çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›çš„æ˜¯ä¸»å­˜å½“ä¸­çš„ data çš„å€¼ç­‰äº 2ï¼Œå› æ­¤ä¸Šé¢çš„ä»£ç æ˜¯å­˜åœ¨é”™è¯¯çš„ã€‚

## è§£å†³æ±‚å’Œé—®é¢˜çš„å„ç§åŠæ³•

### ä½¿ç”¨æ•°ç»„å·§å¦™è§£å†³å¹¶å‘ç¨‹åºå½“ä¸­çš„æ•°æ®ç«äº‰é—®é¢˜

åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå‡½æ•° `omp_get_thread_num` è¿™ä¸ªå‡½æ•°å¯ä»¥è¿”å›çº¿ç¨‹çš„ id å·ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ª id åšä¸€äº›æ–‡ç« ï¼Œå¦‚ä¸‹é¢çš„ç¨‹åºï¼š

```c


#include <stdio.h>
#include <omp.h>
#include <unistd.h>

static int data;

static int tarr[2];

int main() {
  #pragma omp parallel num_threads(2)
  {
    int tid = omp_get_thread_num();
    for(int i = 0; i < 10000; i++) {
      tarr[tid]++;
      usleep(10);
    }
    printf("tarr[%d] = %d tid = %d\n", tid, tarr[tid], tid);
  }
  data = tarr[0] + tarr[1];
  printf("In main function data = %d\n", data);
  return 0;
}
```

åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬é¢å¤–çš„ä½¿ç”¨äº†ä¸€ä¸ªæ•°ç»„ `tarr` ç”¨äºä¿å­˜çº¿ç¨‹çš„æœ¬åœ°çš„å’Œï¼Œç„¶ååœ¨æœ€ååœ¨ä¸»çº¿ç¨‹é‡Œé¢è®²çº¿ç¨‹æœ¬åœ°å¾—åˆ°çš„å’Œç›¸åŠ èµ·æ¥ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å¾—åˆ°çš„ç»“æœå°±æ˜¯æ­£ç¡®çš„äº†ã€‚

```shell
$./lockfree01.out
tarr[1] = 10000 tid = 1
tarr[0] = 10000 tid = 0
In main function data = 20000
```

åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œåªæœ‰å½“å¹¶è¡ŒåŸŸå½“ä¸­æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¸»çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œå¹¶è¡ŒåŸŸåé¢çš„ä»£ç ï¼Œå› æ­¤ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œä»£ç 

```c
  data = tarr[0] + tarr[1];
  printf("In main function data = %d\n", data);
```

ä¹‹å‰ï¼ŒOpenMP ä¸­å¹¶è¡ŒåŸŸä¸­çš„ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œå› æ­¤ä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„æ—¶å€™æ•°ç»„ `tarr` ä¸­çš„ç»“æœå·²ç»è®¡ç®—å‡ºæ¥äº†ï¼Œå› æ­¤ä¸Šé¢çš„ä»£ç æœ€ç»ˆçš„æ‰§è¡Œç»“æœæ˜¯ 2000ã€‚

### reduction å­å¥

åœ¨ä¸Šæ–‡å½“ä¸­æˆ‘ä»¬ä½¿ç”¨æ•°ç»„å»é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ•°æ®çš„æƒ…å†µï¼Œé™¤äº†ä¸Šé¢çš„æ–¹æ³•å¤„ç†æ±‚å’Œé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ reduction å­å¥å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```c

#include <stdio.h>
#include <omp.h>
#include <unistd.h>

static int data;

int main() {
  #pragma omp parallel num_threads(2) reduction(+:data)
  {
    for(int i = 0; i < 10000; i++) {
      data++;
      usleep(10);
    }
    printf("data = %d tid = %d\n", data, omp_get_thread_num());
  }

  printf("In main function data = %d\n", data);
  return 0;
}
```

åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå­å¥ `reduction(+:data)` åœ¨æ¯ä¸ªçº¿ç¨‹é‡Œé¢å¯¹å˜é‡ data è¿›è¡Œæ‹·è´ï¼Œç„¶ååœ¨çº¿ç¨‹å½“ä¸­ä½¿ç”¨è¿™ä¸ªæ‹·è´çš„å˜é‡ï¼Œè¿™æ ·çš„è¯å°±ä¸å­˜åœ¨æ•°æ®ç«äº‰äº†ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨çš„ data æ˜¯ä¸ä¸€æ ·çš„ï¼Œåœ¨ reduction å½“ä¸­è¿˜æœ‰ä¸€ä¸ªåŠ å·â•ï¼Œè¿™ä¸ªåŠ å·è¡¨ç¤ºå¦‚ä½•è¿›è¡Œè§„çº¦æ“ä½œï¼Œæ‰€è°“è§„çº¦æ“ä½œç®€å•è¯´æ¥å°±æ˜¯å¤šä¸ªæ•°æ®é€æ­¥è¿›è¡Œæ“ä½œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªä¸èƒ½å¤Ÿåœ¨è¿›è¡Œè§„çº¦çš„æ•°æ®ã€‚

ä¾‹å¦‚åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬çš„è§„çº¦æ“ä½œæ˜¯ + ï¼Œå› æ­¤éœ€è¦å°†çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 çš„æ•°æ®è¿›è¡Œ + æ“ä½œï¼Œå³çº¿ç¨‹ 1 çš„ data åŠ ä¸Š çº¿ç¨‹ 2 çš„ data å€¼ï¼Œç„¶åå°†å¾—åˆ°çš„ç»“æœèµ‹å€¼ç»™å…¨å±€å˜é‡ dataï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„ç»“æœå°±æ˜¯æ­£ç¡®çš„ã€‚

å¦‚æœæœ‰ 4 ä¸ªçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆå°±æœ‰ 4 ä¸ªçº¿ç¨‹æœ¬åœ°çš„ dataï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ª dataï¼‰ã€‚é‚£ä¹ˆè§„çº¦ï¼ˆreductionï¼‰æ“ä½œçš„ç»“æœç­‰äºï¼š

(((data1 + data2) + data3) + data4) å…¶ä¸­ datai è¡¨ç¤ºç¬¬ i ä¸ªçº¿ç¨‹çš„å¾—åˆ°çš„ data ã€‚
