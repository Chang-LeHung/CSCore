# OpenMP çº¿ç¨‹åŒæ­¥ Construct å®ç°åŸç†ä»¥åŠæºç åˆ†æï¼ˆä¸Šï¼‰

## å‰è¨€

åœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ä¸»è¦ç»™å¤§å®¶ä»‹ç»åœ¨ OpenMP å½“ä¸­ä½¿ç”¨çš„ä¸€äº›åŒæ­¥çš„ construct çš„å®ç°åŸç†ï¼Œå¦‚ master, single, critical ç­‰ç­‰ï¼å¹¶ä¸”ä¼šç»“åˆå¯¹åº”çš„æ±‡ç¼–ç¨‹åºè¿›è¡Œä»”ç»†çš„åˆ†æã€‚ï¼ˆæœ¬ç¯‡æ–‡ç« çš„æ±‡ç¼–ç¨‹åºåˆ†æåŸºäº x86_86 å¹³å°ï¼‰

## Flush Construct

é¦–å…ˆå…ˆäº†è§£ä¸€ä¸‹ flush construct çš„è¯­æ³•ï¼š

```c
#pragma omp flush(å˜é‡åˆ—è¡¨)
```

è¿™ä¸ªæ„é€ æ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯å¢åŠ ä¸€ä¸ªå†…å­˜å±éšœï¼Œä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹é¢çš„æ•°æ®çš„å¯è§æ€§ï¼Œç®€å•æ¥è¯´ä¸€ä¸ªçº¿ç¨‹å¯¹æŸä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹ä¹‹åï¼Œä¿®æ”¹ä¹‹åçš„ç»“æœå¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯è§çš„ã€‚

```c

#include <stdio.h>
#include <omp.h>

int main()
{
  int data = 100;
#pragma omp parallel num_threads(4) default(none) shared(data)
  {
#pragma omp flush(data)
  }
  return 0;
}
```

ä¸Šé¢æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ OpenMP çš„ç¨‹åºï¼Œæ ¹æ®å‰é¢çš„æ–‡ç«  [OpenMp Parallel Construct å®ç°åŸç†ä¸æºç åˆ†æ](https://github.com/Chang-LeHung/openmp-tutorial/blob/master/docs/parallel.md) æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¼šè®²å¹¶è¡ŒåŸŸç¼–è¯‘æˆä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç¼–è¯‘åçš„æ±‡ç¼–ç¨‹åºæ˜¯æ€ä¹ˆæ ·çš„ï¼

gcc-4 ç¼–è¯‘ä¹‹åçš„ç»“æœ

```asm
00000000004005f6 <main._omp_fn.0>:
  4005f6:       55                      push   %rbp
  4005f7:       48 89 e5                mov    %rsp,%rbp
  4005fa:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  4005fe:       0f ae f0                mfence 
  400601:       5d                      pop    %rbp
  400602:       c3                      retq   
  400603:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)
  40060a:       00 00 00 
  40060d:       0f 1f 00                nopl   (%rax)
```

ä»ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ä¸€æ¡æŒ‡ä»¤æ˜¯ mfence è¿™æ˜¯ä¸€æ¡ full çš„å†…å­˜å±éšœï¼Œç”¨äºä¿éšœæ•°æ®çš„å¯è§æ€§ï¼Œä¸»è¦æ˜¯ cache line ä¸­æ•°æ®çš„å¯è§æ€§ã€‚

gcc-11 ç¼–è¯‘ä¹‹åçš„ç»“æœ

```asm
0000000000401165 <main._omp_fn.0>:
  401165:       55                      push   %rbp
  401166:       48 89 e5                mov    %rsp,%rbp
  401169:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  40116d:       f0 48 83 0c 24 00       lock orq $0x0,(%rsp)
  401173:       5d                      pop    %rbp
  401174:       c3                      retq   
  401175:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)
  40117c:       00 00 00 
  40117f:       90                      nop
```

ä»ç¼–è¯‘ä¹‹åçš„ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ªæ±‡ç¼–ç¨‹åºä¸»è¦æ˜¯ä½¿ç”¨ lock æŒ‡ä»¤å®ç°å¯è§æ€§ï¼Œæˆ‘ä»¬çŸ¥é“ lock æŒ‡ä»¤æ˜¯ç”¨æ¥ä¿è¯åŸå­æ€§çš„ï¼Œä½†æ˜¯äº‹å®ä¸Šè¿™åŒæ ·ä¹Ÿä¿è¯æ¥å¯è§æ€§ï¼Œè¯•æƒ³ä¸€ä¸‹å¦‚æœä¸ä¿è¯å¯è§æ€§æ˜¯ä¸èƒ½å¤Ÿä¿è¯åŸå­æ€§çš„ï¼å› ä¸ºå¦‚æœè¿™ä¸ªçº¿ç¨‹çœ‹åˆ°çš„æ•°æ®éƒ½ä¸æ˜¯æœ€æ–°ä¿®æ”¹çš„æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆå³ä½¿æ“ä½œæ˜¯åŸå­çš„é‚£ä¹ˆä¹Ÿè¾¾ä¸åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚

ä¸Šé¢ä¸¤ç§æ–¹å¼çš„ç¼–è¯‘å§è‹¥å¹²çš„ä¸»è¦åŒºåˆ«å°±æ˜¯ä¸€ä¸ªä½¿ç”¨ lock æŒ‡ä»¤ï¼Œä¸€ä¸ªä½¿ç”¨ mfence æŒ‡ä»¤ï¼Œå®é™…ä¸Š lock çš„æ•ˆç‡æ¯” mfence æ•ˆç‡æ›´é«˜å› æ­¤åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œç°åœ¨éƒ½æ˜¯ä½¿ç”¨ lock æŒ‡ä»¤è¿›è¡Œå®ç°ã€‚

åœ¨æˆ‘çš„æœºå™¨ä¸Šä¸‹é¢çš„ä»£ç åˆ†åˆ«ä½¿ç”¨ gcc-11 å’Œ gcc-4 ç¼–è¯‘ä¹‹åæ‰§è¡Œçš„ç»“æœå·®å¼‚å¾ˆå¤§ï¼Œgcc-11 å¤§çº¦ä½¿ç”¨äº† 11 ç§’ï¼Œè€Œ gcc-4 ç¼–è¯‘å‡ºæ¥çš„ç»“æœæ‰§è¡Œäº† 20 ç§’ï¼Œè¿™å…¶ä¸­ä¸»è¦çš„åŒºåˆ«å°±æ˜¯ lock æŒ‡ä»¤å’Œ mfence æŒ‡ä»¤çš„å·®å¼‚ã€‚

```c

#include <stdio.h>
#include <omp.h>

int main()
{
  double start = omp_get_wtime();
  for(long i = 0; i < 1000000000L; ++i)
  {
    __sync_synchronize();
  }
  printf("time = %lf\n", omp_get_wtime() - start);
  return 0;
}
```

## Master Construct

master construct çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
#pragma omp master
```

äº‹å®ä¸Šç¼–è¯‘å™¨ä¼šå°†ä¸Šé¢çš„ç¼–è¯‘æŒ‡å¯¼è¯­å¥ç¼–è¯‘æˆä¸ä¸‹é¢çš„ä»£ç ç­‰ä»·çš„æ±‡ç¼–ç¨‹åºï¼š

```c
if (omp_get_thread_num () == 0)
  block // master çš„ä»£ç å—
```

æˆ‘ä»¬ç°åœ¨æ¥åˆ†æä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œçœ‹çœ‹ç¨‹åºç¼–è¯‘ä¹‹åçš„ç»“æœæ˜¯ä»€ä¹ˆï¼š

```c
#include <stdio.h>
#include <omp.h>

int main()
{
#pragma omp parallel num_threads(4) default(none)
  {
#pragma omp master
    {
      printf("I am master and my tid = %d\n", omp_get_thread_num());
    }
  }
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºç¼–è¯‘ä¹‹åçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼ˆæ±‡ç¼–ç¨‹åºçš„å¤§è‡´åˆ†æå¦‚ä¸‹ï¼‰ï¼š

```asm
000000000040117a <main._omp_fn.0>:
  40117a:       55                      push   %rbp
  40117b:       48 89 e5                mov    %rsp,%rbp
  40117e:       48 83 ec 10             sub    $0x10,%rsp
  401182:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  401186:       e8 a5 fe ff ff          callq  401030 <omp_get_thread_num@plt> # å¾—åˆ°çº¿ç¨‹çš„ id å¹¶ä¿å­˜åˆ° eax å¯„å­˜å™¨å½“ä¸­
  40118b:       85 c0                   test   %eax,%eax # çœ‹çœ‹å¯„å­˜å™¨ eax æ˜¯ä¸æ˜¯ç­‰äº 0
  40118d:       75 16                   jne     4011a5  <main._omp_fn.0+0x2b> # å¦‚æœä¸ç­‰äº 0 åˆ™è·³è½¬åˆ° 4011a5 çš„ä½ç½® ä¹Ÿå°±æ˜¯ç›´æ¥é€€å‡ºç¨‹åºäº† å¦‚æœæ˜¯é‚£ä¹ˆå°±ç»§ç»­æ‰§è¡Œåé¢çš„ printf è¯­å¥
  40118f:       e8 9c fe ff ff          callq  401030 <omp_get_thread_num@plt>
  401194:       89 c6                   mov    %eax,%esi
  401196:       bf 10 20 40 00          mov    $0x402010,%edi
  40119b:       b8 00 00 00 00          mov    $0x0,%eax
  4011a0:       e8 9b fe ff ff          callq  401040 <printf@plt>
  4011a5:       90                      nop
  4011a6:       c9                      leaveq 
  4011a7:       c3                      retq   
  4011a8:       0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)
  4011af:       00 
```

è¿™é‡Œæˆ‘ä»¬åªéœ€è¦äº†è§£ä¸€ä¸‹ test æŒ‡ä»¤å°±èƒ½å¤Ÿç†è§£ä¸Šé¢çš„æ±‡ç¼–ç¨‹åºäº†ï¼Œ"test %eax, %eax" æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸€æ¡æŒ‡ä»¤ï¼Œå®ƒçš„å«ä¹‰æ˜¯å¯¹å¯„å­˜å™¨ EAX å’Œ EAX è¿›è¡Œé€»è¾‘ä¸è¿ç®—ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨çŠ¶æ€å¯„å­˜å™¨ä¸­ï¼Œä½†æ˜¯ä¸æ”¹å˜ EAX çš„å€¼ã€‚è¿™æ¡æŒ‡ä»¤ä¼šå½±å“æ ‡å¿—ä½ï¼ˆå¦‚ ZFã€SFã€OFï¼‰ï¼Œå¯ç”¨äºåˆ¤æ–­ EAX æ˜¯å¦ç­‰äºé›¶ã€‚

ä»ä¸Šé¢çš„æ±‡ç¼–ç¨‹åºåˆ†ææˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œmaster construct å°±æ˜¯ä¸€æ¡ if è¯­å¥ï¼Œä½†æ˜¯åé¢æˆ‘ä»¬å°†è¦è°ˆåˆ°çš„ single ä¸ä¸€æ ·ä»–è¿˜éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚

## Critical Construct

### #pragma omp critical

é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£çš„æ˜¯ critical çš„ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼Œåœ¨ OpenMP å½“ä¸­ critical å­å¥æœ‰ä»¥ä¸‹ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼š

```c
#pragma omp critical
#pragma omp critical(name)
```

éœ€è¦äº†è§£çš„æ˜¯åœ¨ OpenMP å½“ä¸­æ¯ä¸€ä¸ª critical å­å¥çš„èƒŒåéƒ½ä¼šä½¿ç”¨åˆ°ä¸€ä¸ªé”ï¼Œä¸åŒçš„ name å¯¹åº”ä¸åŒçš„é”ï¼Œå¦‚æœä½ ä½¿ç”¨ç¬¬ä¸€ç§ critical çš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯ä½¿ç”¨ OpenMP é»˜è®¤çš„å…¨å±€é”ï¼Œéœ€è¦çŸ¥é“çš„æ˜¯åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½å¤Ÿæœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœä½ åœ¨ä½ çš„ä»£ç å½“ä¸­ä½¿ç”¨å…¨å±€çš„ critical çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦æ³¨æ„ä»–çš„æ•ˆç‡ï¼Œå› ä¸ºåœ¨ä¸€ä¸ªæ—¶åˆ»åªèƒ½å¤Ÿæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆåˆ†æç¬¬ä¸€ç§ä½¿ç”¨æ–¹å¼ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä»€ä¹ˆæ ·çš„ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ `#pragma omp critical` é‚£ä¹ˆåœ¨å®é™…çš„æ±‡ç¼–ç¨‹åºå½“ä¸­ä¼šä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªåŠ¨æ€åº“å‡½æ•°ï¼ŒGOMP_critical_start åœ¨åˆšè¿›å…¥ä¸´ç•ŒåŒºçš„æ—¶å€™è°ƒç”¨ï¼ŒGOMP_critical_end åœ¨ç¦»å¼€ä¸´ç•ŒåŒºçš„æ—¶å€™è°ƒç”¨ã€‚

```c
void GOMP_critical_start (void);
void GOMP_critical_end (void);
```

æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºè¿›è¡Œè¯´æ˜ï¼š

```c
#include <stdio.h>
#include <omp.h>

int main()
{
  int data = 0;
#pragma omp parallel num_threads(4) default(none) shared(data)
  {
#pragma omp critical
    {
      data++;
    }
  }
  printf("data = %d\n", data);
  return 0;
}
```

æ ¹æ®æˆ‘ä»¬å‰é¢çš„ä¸€äº›æ–‡ç« çš„åˆ†æï¼Œå¹¶è¡ŒåŸŸåœ¨ç»è¿‡ç¼–è¯‘ä¹‹åä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå‡½æ•°ï¼Œä¸Šé¢çš„ç¨‹åºåœ¨è¿›è¡Œç¼–è¯‘ä¹‹åæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š

```asm
00000000004011b7 <main._omp_fn.0>:
  4011b7:       55                      push   %rbp
  4011b8:       48 89 e5                mov    %rsp,%rbp
  4011bb:       48 83 ec 10             sub    $0x10,%rsp
  4011bf:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  4011c3:       e8 b8 fe ff ff          callq  401080 <GOMP_critical_start@plt>
  4011c8:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  4011cc:       8b 00                   mov    (%rax),%eax
  4011ce:       8d 50 01                lea    0x1(%rax),%edx
  4011d1:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  4011d5:       89 10                   mov    %edx,(%rax)
  4011d7:       e8 54 fe ff ff          callq  401030 <GOMP_critical_end@plt>
  4011dc:       c9                      leaveq 
  4011dd:       c3                      retq   
  4011de:       66 90                   xchg   %ax,%ax
```

ä»ä¸Šé¢çš„åæ±‡ç¼–ç»“æœæ¥çœ‹ç¡®å®è°ƒç”¨äº† GOMP_critical_start å’Œ GOMP_critical_end ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åˆ†åˆ«æ˜¯åœ¨è¿›å…¥ä¸´ç•ŒåŒºä¹‹å‰å’Œç¦»å¼€ä¸´ç•ŒåŒºä¹‹å‰è°ƒç”¨çš„ã€‚åœ¨ GOMP_critical_start å‡½æ•°ä¸­ä¼šè¿›è¡ŒåŠ é”æ“ä½œï¼Œåœ¨å‡½æ•° GOMP_critical_end å½“ä¸­ä¼šè¿›è¡Œè§£é”æ“ä½œï¼Œåœ¨å‰é¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡ï¼Œè¿™ä¸ªåŠ é”å’Œè§£é”æ“ä½œä½¿ç”¨çš„æ˜¯ OpenMP å†…éƒ¨çš„é»˜è®¤çš„å…¨å±€é”ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„æºç¨‹åºï¼š

```c
void
GOMP_critical_start (void)
{
  /* There is an implicit flush on entry to a critical region. */
  __atomic_thread_fence (MEMMODEL_RELEASE);
  gomp_mutex_lock (&default_lock); // default_lock æ˜¯ä¸€ä¸ª OpenMP å†…éƒ¨çš„é”
}

void
GOMP_critical_end (void)
{
  gomp_mutex_unlock (&default_lock);
}
```

ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹ä¸»è¦æ˜¯è°ƒç”¨ gomp_mutex_lock è¿›è¡ŒåŠ é”æ“ä½œï¼Œè°ƒç”¨ gomp_mutex_unlock è¿›è¡Œè§£é”æ“ä½œï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„å†…éƒ¨å®ç°åŸç†æˆ‘ä»¬åœ¨å‰é¢çš„æ–‡ç« å½“ä¸­å·²ç»è¿›è¡Œäº†è¯¦ç»†çš„è§£é‡Šè¯´æ˜å’Œåˆ†æï¼Œå¦‚æœå¤§å®¶æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  [OpenMP Runtime Library : Openmp å¸¸è§çš„åŠ¨æ€åº“å‡½æ•°ä½¿ç”¨ï¼ˆä¸‹ï¼‰â€”â€”æ·±å…¥å‰–æé”ğŸ”’åŸç†ä¸å®ç°](https://github.com/Chang-LeHung/openmp-tutorial/blob/master/docs/runtime02.md) ã€‚

### #pragma omp critical(name)

å¦‚æœæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤çš„ critical çš„è¯ï¼Œé‚£ä¹ˆè°ƒç”¨çš„åº“å‡½æ•°å’Œå‰é¢æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…·ä½“æ¥è¯´æ˜¯è°ƒç”¨ä¸‹é¢ä¸¤ä¸ªåº“å‡½æ•°ï¼š

```c
void GOMP_critical_name_end (void **pptr);
void GOMP_critical_name_start (void **pptr);
```

å…¶ä¸­ pptr æ˜¯æŒ‡å‘ä¸€ä¸ªæŒ‡å‘é”çš„æŒ‡é’ˆï¼Œåœ¨å‰é¢çš„æ–‡ç«  [OpenMP Runtime Library : Openmp å¸¸è§çš„åŠ¨æ€åº“å‡½æ•°ä½¿ç”¨ï¼ˆä¸‹ï¼‰â€”â€”æ·±å…¥å‰–æé”ğŸ”’åŸç†ä¸å®ç°](https://github.com/Chang-LeHung/openmp-tutorial/blob/master/docs/runtime02.md)  å½“ä¸­æˆ‘ä»¬ä»”ç»†è®¨è®ºè¿‡è¿™ä¸ªé”å…¶å®å°±æ˜¯ä¸€ä¸ª int ç±»å‹çš„å˜é‡ã€‚è¿™ä¸ªå˜é‡åœ¨ç¼–è¯‘æœŸé—´å°±ä¼šåœ¨ bss èŠ‚åˆ†é…ç©ºé—´ï¼Œåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å°†å…¶åˆå§‹åŒ–ä¸º 0 ï¼Œè¡¨ç¤ºæ²¡ä¸Šé”çš„çŠ¶æ€ï¼Œå…³äºè¿™ä¸€ç‚¹åœ¨ä¸Šé¢è°ˆåˆ°çš„æ–‡ç« å½“ä¸­æœ‰ä»”ç»†çš„è®¨è®ºã€‚

è¿™é‡Œå¯èƒ½éœ€è¦åŒºåˆ†ä¸€ä¸‹ data èŠ‚å’Œ bss èŠ‚ï¼Œ.data èŠ‚æ˜¯ç”¨æ¥å­˜æ”¾ç¨‹åºä¸­å®šä¹‰çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„åˆå§‹å€¼çš„å†…å­˜åŒºåŸŸã€‚è¿™äº›å˜é‡çš„å€¼åœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œå‰å°±å·²ç»ç¡®å®šã€‚.bss èŠ‚æ˜¯ç”¨æ¥å­˜æ”¾ç¨‹åºä¸­å®šä¹‰çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„æœªåˆå§‹åŒ–çš„å†…å­˜åŒºåŸŸã€‚è¿™äº›å˜é‡åœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œå‰å¹¶æ²¡æœ‰åˆå§‹åŒ–çš„å€¼ã€‚åœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ï¼Œè¿™äº›å˜é‡ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ–ä¸º0ã€‚æ€»çš„æ¥è¯´ï¼Œ.data å­˜æ”¾å·²åˆå§‹åŒ–æ•°æ®ï¼Œ.bsså­˜æ”¾æœªåˆå§‹åŒ–æ•°æ®ã€‚

æˆ‘ä»¬ç°åœ¨æ¥åˆ†æä¸€ä¸ªå‘½åçš„ critical å­å¥ä»–çš„æ±‡ç¼–ç¨‹åºï¼š

```c
#include <stdio.h>
#include <omp.h>

int main()
{
  int data = 0;
#pragma omp parallel num_threads(4) default(none) shared(data)
  {
#pragma omp critical(A)
    {
      data++;
    }
  }
  printf("data = %d\n", data);
  return 0;
}
```

ä¸Šé¢çš„ä»£ç ç»è¿‡ç¼–è¯‘ä¹‹åå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š

```asm
00000000004011b7 <main._omp_fn.0>:
  4011b7:       55                      push   %rbp
  4011b8:       48 89 e5                mov    %rsp,%rbp
  4011bb:       48 83 ec 10             sub    $0x10,%rsp
  4011bf:       48 89 7d f8             mov    %rdi,-0x8(%rbp)
  4011c3:       bf 58 40 40 00          mov    $0x404058,%edi
  4011c8:       e8 a3 fe ff ff          callq  401070 <GOMP_critical_name_start@plt>
  4011cd:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  4011d1:       8b 00                   mov    (%rax),%eax
  4011d3:       8d 50 01                lea    0x1(%rax),%edx
  4011d6:       48 8b 45 f8             mov    -0x8(%rbp),%rax
  4011da:       89 10                   mov    %edx,(%rax)
  4011dc:       bf 58 40 40 00          mov    $0x404058,%edi
  4011e1:       e8 4a fe ff ff          callq  401030 <GOMP_critical_name_end@plt>
  4011e6:       c9                      leaveq 
  4011e7:       c3                      retq   
  4011e8:       0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)
```

ä»ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨å‡½æ•° GOMP_critical_name_start æ—¶ï¼Œä¼ é€’çš„å‚æ•°çš„å€¼ä¸º 0x404058 ï¼ˆæ˜¾ç„¶è¿™ä¸ªå°±æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ç¡®å®šçš„ï¼‰ï¼Œæˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹ 0x404058 ä½ç½®åœ¨å“ªä¸€ä¸ªèŠ‚ã€‚

æ ¹æ® x86 çš„è°ƒç”¨è§„çº¦ï¼Œrdi/edi å¯„å­˜å™¨å­˜å‚¨çš„å°±æ˜¯è°ƒç”¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œåœ¨å‡½æ•° GOMP_critical_name_start è¢«è°ƒç”¨ä¹‹å‰æˆ‘ä»¬å¯ä»¥çœ‹åˆ° edi å¯„å­˜å™¨çš„å€¼æ˜¯ 0x404058 ï¼Œ(`mov $0x404058,%edi`) å› æ­¤ pptr æŒ‡é’ˆçš„å€¼å°±æ˜¯ 0x404058 ã€‚

ä¸ºäº†ç¡®å®šæŒ‡é’ˆæŒ‡å‘çš„æ•°æ®çš„ä½ç½®æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹èŠ‚å¤´è¡¨å½“ä¸­å„ä¸ªèŠ‚åœ¨å¯æ‰§è¡Œç¨‹åºå½“ä¸­çš„ä½ç½®ï¼Œåˆ¤æ–­ 0x404058 åœ¨å“ªä¸ªèŠ‚å½“ä¸­ï¼Œä¸Šé¢çš„ç¨‹åºçš„èŠ‚å¤´è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .interp           PROGBITS         00000000004002a8  000002a8
       000000000000001c  0000000000000000   A       0     0     1
  [ 2] .note.gnu.build-i NOTE             00000000004002c4  000002c4
       0000000000000024  0000000000000000   A       0     0     4
  [ 3] .note.ABI-tag     NOTE             00000000004002e8  000002e8
       0000000000000020  0000000000000000   A       0     0     4
  [ 4] .gnu.hash         GNU_HASH         0000000000400308  00000308
       0000000000000060  0000000000000000   A       5     0     8
  [ 5] .dynsym           DYNSYM           0000000000400368  00000368
       00000000000001e0  0000000000000018   A       6     1     8
  [ 6] .dynstr           STRTAB           0000000000400548  00000548
       0000000000000111  0000000000000000   A       0     0     1
  [ 7] .gnu.version      VERSYM           000000000040065a  0000065a
       0000000000000028  0000000000000002   A       5     0     2
  [ 8] .gnu.version_r    VERNEED          0000000000400688  00000688
       0000000000000050  0000000000000000   A       6     2     8
  [ 9] .rela.dyn         RELA             00000000004006d8  000006d8
       0000000000000018  0000000000000018   A       5     0     8
  [10] .rela.plt         RELA             00000000004006f0  000006f0
       0000000000000090  0000000000000018  AI       5    22     8
  [11] .init             PROGBITS         0000000000401000  00001000
       000000000000001a  0000000000000000  AX       0     0     4
  [12] .plt              PROGBITS         0000000000401020  00001020
       0000000000000070  0000000000000010  AX       0     0     16
  [13] .text             PROGBITS         0000000000401090  00001090
       00000000000001d2  0000000000000000  AX       0     0     16
  [14] .fini             PROGBITS         0000000000401264  00001264
       0000000000000009  0000000000000000  AX       0     0     4
  [15] .rodata           PROGBITS         0000000000402000  00002000
       000000000000001b  0000000000000000   A       0     0     8
  [16] .eh_frame_hdr     PROGBITS         000000000040201c  0000201c
       000000000000003c  0000000000000000   A       0     0     4
  [17] .eh_frame         PROGBITS         0000000000402058  00002058
       0000000000000110  0000000000000000   A       0     0     8
  [18] .init_array       INIT_ARRAY       0000000000403df8  00002df8
       0000000000000008  0000000000000008  WA       0     0     8
  [19] .fini_array       FINI_ARRAY       0000000000403e00  00002e00
       0000000000000008  0000000000000008  WA       0     0     8
  [20] .dynamic          DYNAMIC          0000000000403e08  00002e08
       00000000000001f0  0000000000000010  WA       6     0     8
  [21] .got              PROGBITS         0000000000403ff8  00002ff8
       0000000000000008  0000000000000008  WA       0     0     8
  [22] .got.plt          PROGBITS         0000000000404000  00003000
       0000000000000048  0000000000000008  WA       0     0     8
  [23] .data             PROGBITS         0000000000404048  00003048
       0000000000000004  0000000000000000  WA       0     0     1
  [24] .bss              NOBITS           0000000000404050  0000304c
       0000000000000010  0000000000000000  WA       0     0     8
  [25] .comment          PROGBITS         0000000000000000  0000304c
       000000000000005b  0000000000000001  MS       0     0     1
  [26] .debug_aranges    PROGBITS         0000000000000000  000030a7
       0000000000000030  0000000000000000           0     0     1
  [27] .debug_info       PROGBITS         0000000000000000  000030d7
       0000000000000115  0000000000000000           0     0     1
  [28] .debug_abbrev     PROGBITS         0000000000000000  000031ec
       00000000000000d7  0000000000000000           0     0     1
  [29] .debug_line       PROGBITS         0000000000000000  000032c3
       00000000000000a7  0000000000000000           0     0     1
  [30] .debug_str        PROGBITS         0000000000000000  0000336a
       0000000000000122  0000000000000001  MS       0     0     1
  [31] .symtab           SYMTAB           0000000000000000  00003490
       00000000000003c0  0000000000000018          32    21     8
  [32] .strtab           STRTAB           0000000000000000  00003850
       000000000000023c  0000000000000000           0     0     1
  [33] .shstrtab         STRTAB           0000000000000000  00003a8c
       0000000000000143  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)
```

ä»ä¸Šé¢çš„èŠ‚å¤´è¡¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ 24 ä¸ªå°èŠ‚ bss ä»–çš„èµ·å§‹åœ°å€ä¸º 0000000000404050 ä¸€å…±ç«™ 16 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ 0x404058 æŒ‡å‘çš„æ•°æ®åœ¨ bss èŠ‚çš„æ•°æ®èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯è¯´é”å¯¹åº”çš„ int ç±»å‹ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰çš„æ•°æ®åœ¨ bss èŠ‚ï¼Œç¨‹åºæ‰§è¡Œçš„æ—¶å€™ä¼šå°† bss èŠ‚å½“ä¸­çš„æ•°æ®åˆå§‹åŒ–ä¸º 0ï¼Œ 0 è¡¨ç¤ºæ— é”çŠ¶æ€ã€‚

æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹å‡½æ•° GOMP_critical_name_start æºä»£ç ï¼ˆä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹åˆ é™¤äº†éƒ¨åˆ†ä»£ç ï¼‰ï¼š

```c
void
GOMP_critical_name_start (void **pptr)
{
  gomp_mutex_t *plock;

  /* If a mutex fits within the space for a pointer, and is zero initialized,
     then use the pointer space directly.  */
  if (GOMP_MUTEX_INIT_0
      && sizeof (gomp_mutex_t) <= sizeof (void *)
      && __alignof (gomp_mutex_t) <= sizeof (void *))
    plock = (gomp_mutex_t *)pptr; // gomp_mutex_t å°±æ˜¯ int ç±»å‹

  gomp_mutex_lock (plock);
}

```

ä»è¯­å¥ `plock = (gomp_mutex_t *)pptr` å¯ä»¥çŸ¥é“å°†ä¼ é€’çš„å‚æ•°ä½œä¸ºä¸€ä¸ª int ç±»å‹çš„æŒ‡é’ˆä½¿ç”¨ï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯ bss èŠ‚çš„æ•°æ®ï¼Œç„¶åå¯¹è¿™ä¸ªæ•°æ®è¿›è¡ŒåŠ é”æ“ä½œï¼ˆ`gomp_mutex_lock (plock)`ï¼‰ï¼Œå…³äºå‡½æ•° gomp_mutex_lock ï¼Œåœ¨æ–‡ç«   [OpenMP Runtime Library : Openmp å¸¸è§çš„åŠ¨æ€åº“å‡½æ•°ä½¿ç”¨ï¼ˆä¸‹ï¼‰â€”â€”æ·±å…¥å‰–æé”ğŸ”’åŸç†ä¸å®ç°](https://github.com/Chang-LeHung/openmp-tutorial/blob/master/docs/runtime02.md)  å½“ä¸­æœ‰è¯¦ç»†çš„è®²è§£ ã€‚

æˆ‘ä»¬åœ¨æ¥çœ‹ä¸€ä¸‹ GOMP_critical_name_end çš„æºä»£ç ï¼š

```c
void
GOMP_critical_name_end (void **pptr)
{
  gomp_mutex_t *plock;

  /* If a mutex fits within the space for a pointer, and is zero initialized,
     then use the pointer space directly.  */
  if (GOMP_MUTEX_INIT_0
      && sizeof (gomp_mutex_t) <= sizeof (void *)
      && __alignof (gomp_mutex_t) <= sizeof (void *))
    plock = (gomp_mutex_t *)pptr;
  else
    plock = *pptr;

  gomp_mutex_unlock (plock);
}
```

åŒæ ·çš„è¿˜æ˜¯ä½¿ç”¨ bss èŠ‚çš„æ•°æ®è¿›è¡Œè§£é”æ“ä½œï¼Œå…³äºåŠ é”è§£é”æ“ä½œçš„ç»†èŠ‚å¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç«  [OpenMP Runtime Library : Openmp å¸¸è§çš„åŠ¨æ€åº“å‡½æ•°ä½¿ç”¨ï¼ˆä¸‹ï¼‰â€”â€”æ·±å…¥å‰–æé”ğŸ”’åŸç†ä¸å®ç°](https://github.com/Chang-LeHung/openmp-tutorial/blob/master/docs/runtime02.md)  ã€‚

## æ€»ç»“

åœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ä¸»è¦ç»™å¤§å®¶ä»‹ç»äº† flush, master å’Œ critical æŒ‡ä»¤çš„å®ç°ç»†èŠ‚å’Œä»–çš„è°ƒç”¨çš„åº“å‡½æ•°ï¼Œå¹¶ä¸”æ·±å…¥åˆ†æäº†è¿™å‡ ä¸ª construct å½“ä¸­è®¾è®¡çš„åº“å‡½æ•°çš„æºä»£ç ï¼Œå¸Œæœ›å¤§å®¶æœ‰æ‰€æ”¶è·ã€‚

---

æ›´å¤šç²¾å½©å†…å®¹åˆé›†å¯è®¿é—®é¡¹ç›®ï¼š<https://github.com/Chang-LeHung/CSCore>

å…³æ³¨å…¬ä¼—å·ï¼šä¸€æ— æ˜¯å¤„çš„ç ”ç©¶åƒ§ï¼Œäº†è§£æ›´å¤šè®¡ç®—æœºï¼ˆJavaã€Pythonã€è®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€ç®—æ³•ä¸æ•°æ®ç»“æ„ï¼‰çŸ¥è¯†ã€‚

