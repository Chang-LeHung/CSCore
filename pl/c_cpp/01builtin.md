# gcc å¥½ç©çš„ builtin å‡½æ•°

## å‰è¨€

åœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ä¸»è¦æƒ³ç»™å¤§å®¶ä»‹ç»ä¸€äº›åœ¨ gcc ç¼–è¯‘å™¨å½“ä¸­ç»™æˆ‘ä»¬æä¾›çš„ä¸€äº›å¥½ç©çš„å†…åµŒå‡½æ•° (builtin function)ğŸ¤£ğŸ¤£ğŸ¤£ ã€‚

## __builtin_frame_address

### ä½¿ç”¨å†…åµŒå‡½æ•°å®ç°

```c
__builtin_frame_address(x) // å…¶ä¸­ x ä¸€ä¸ªæ•´æ•°
```

 è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨äºå¾—åˆ°å‡½æ•°çš„æ ˆå¸§çš„ï¼Œæ›´å…·ä½“çš„æ¥è¯´æ˜¯å¾—åˆ°å‡½æ•°çš„ rbp ï¼ˆå¦‚æœæ˜¯ x86_64 çš„æœºå™¨ï¼Œåœ¨ 32 ä½ç³»ç»Ÿä¸Šå°±æ˜¯ ebpï¼‰çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ ˆå¸§çš„æ ˆåº•çš„å€¼ã€‚

![03](../../images/programming/03.png)

æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ä¸€ä¸ªä¾‹å­æ¥éªŒè¯æµ‹è¯•ä¸€ä¸‹ï¼š

```c

#include <stdio.h>

void func_a()
{
  void* p = __builtin_frame_address(0);
  printf("fun_a frame address = %p\n", p);
}


int main()
{
  void* p = __builtin_frame_address(0);
  printf("main frame address = %p\n", p);
  func_a();
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
main frame address = 0x7ffcecdd7a00
fun_a frame address = 0x7ffcecdd79d0
```

ä¸Šé¢è¾“å‡ºçš„ç»“æœå°±æ˜¯æ¯ä¸ªå‡½æ•°çš„æ ˆå¸§ä¸­æ ˆåº• rbp/ebp å¯„å­˜å™¨çš„å€¼ï¼Œå¯èƒ½ä½ ä¼šæœ‰ç–‘é—®ï¼Œå‡­ä»€ä¹ˆè¯´è¿™ä¸ªå€¼å°±æ˜¯ rbp çš„å€¼ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚æˆ‘ä»¬ç°åœ¨æ¥è¯æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç è·å–å¾—åˆ° rbp çš„å€¼ã€‚

### ä½¿ç”¨å†…æ•›æ±‡ç¼–å®ç°

```c


#include <stdio.h>
#include <sys/types.h>

u_int64_t rbp;

#define frame_address                   \
        asm volatile(                   \
          "movq %%rbp, %0;"             \
          :"=m"(rbp)::                  \
        );                              \
        printf("rbp = %p from inline assembly\n", (void*) rbp);

void bar()
{
  void* rbp = __builtin_frame_address(0);
  printf("rbp = %p\n", rbp);
  frame_address
}

int main()
{
  bar();
  return 0;
}
```

åœ¨ä¸Šé¢çš„ç¨‹åºå½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€æ®µå®å¯ä»¥å¾—åˆ°å¯„å­˜å™¨ rbp çš„å€¼ï¼ˆåœ¨ä¸Šé¢çš„ä»£ç å½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å†…æ•›æ±‡ç¼–å¾—åˆ° rbp çš„å€¼ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå€¼å­˜å‚¨åˆ°å˜é‡ rbp å½“ä¸­ï¼‰ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå€¼å’Œ builtin å‡½æ•°çš„è¿”å›å€¼è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¿”å›çš„æ˜¯ä¸æ˜¯å¯„å­˜å™¨ rbp çš„å€¼äº†ï¼Œä¸Šé¢çš„ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
rbp = 0x7ffe9676ac00
rbp = 0x7ffe9676ac00 from inline assembly
```

ä»ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå†…ç½®å‡½æ•°è¿”å›çš„ç¡®å®æ˜¯å¯„å­˜å™¨ rbp çš„å€¼ã€‚

äº‹å®ä¸Šæˆ‘ä»¬é™¤äº†å¯ä»¥è·å–å½“å‰å‡½æ•°çš„æ ˆå¸§ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è·å–è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ï¼Œå…·ä½“æ ¹æ® x çš„å€¼è¿›è¡Œç¡®å®šï¼š

- x = 0 : è·å–å½“å‰å‡½æ•°çš„æ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯æ ˆåº•çš„ä½ç½®ã€‚
- x = 1 : è·å–è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ã€‚
- x = 2 : è·å–è°ƒç”¨å‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ã€‚
- ......

æ¯”å¦‚è¯´ä¸‹é¢çš„ç¨‹åºï¼š

```c
#include <stdio.h>

void func_a()
{
  void* p = __builtin_frame_address(1);
  printf("caller frame address = %p\n", p);
}


int main()
{
  void* p = __builtin_frame_address(0);
  printf("main frame address = %p\n", p);
  func_a();
  return 0;
}
```

ä¸Šé¢ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
main frame address = 0x7ffda7a4b460
caller frame address = 0x7ffda7a4b460
```

ä»ä¸Šé¢çš„è¾“å‡ºç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“å‚æ•°çš„å€¼ç­‰äº 1 çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ã€‚

```c

#include <stdio.h>

void func_a()
{
  printf("In func_a\n");
  void* p = __builtin_frame_address(2);
  printf("caller frame address = %p\n", p);
}

void func_b()
{
  printf("In func_b\n");
  void* p = __builtin_frame_address(1);
  printf("caller frame address = %p\n", p);

  func_a();
}


int main()
{
  void* p = __builtin_frame_address(0);
  printf("main frame address = %p\n", p);
  func_b();
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
main frame address = 0x7ffdadbe6ff0
In func_b
caller frame address = 0x7ffdadbe6ff0
In func_a
caller frame address = 0x7ffdadbe6ff0
```

åœ¨ä¸Šæ–¹çš„ç¨‹åºå½“ä¸­æˆ‘ä»¬åœ¨ä¸»å‡½æ•°è°ƒç”¨å‡½æ•° func_b ï¼Œç„¶ååœ¨å‡½æ•° func_b å½“ä¸­è°ƒç”¨å‡½æ•° func_a ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ ¹æ®å‚æ•° x çš„ä¸åŒï¼Œè¿”å›çš„æ ˆå¸§çš„å±‚çº§ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ ¹æ®å‰é¢å‚æ•° x çš„æ„ä¹‰æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä»–ä»¬å¾—åˆ°çš„éƒ½æ˜¯ä¸»å‡½æ•°çš„æ ˆå¸§ã€‚

## __builtin_return_address

### ä½¿ç”¨å†…åµŒå‡½æ•°å®ç°

è¿™ä¸ªå†…åµŒå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¾—åˆ°å‡½æ•°çš„è¿”å›åœ°å€ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå½“æˆ‘ä»¬è¿›è¡Œå‡½æ•°è°ƒç”¨çš„æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åè¿”å›åˆ°ä»€ä¹ˆåœ°æ–¹ï¼Œå› ä¸º cpu åªä¼šä¸€æ¡æŒ‡ä»¤ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ cpu ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œå› æ­¤å½“æˆ‘ä»¬è¿›è¡Œå‡½æ•°è°ƒç”¨çš„æ—¶å€™éœ€è¦ä¿å­˜è°ƒç”¨å‡½æ•°çš„ call æŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œå¹¶ä¸”å°†å®ƒä¿å­˜åœ¨æ ˆä¸Šï¼Œå½“è¢«è°ƒç”¨å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åç»§ç»­å›åˆ°è°ƒç”¨å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®æ‰§è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†è¿™ä¸ªä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°æ ˆä¸Šäº†ï¼Œå½“è°ƒç”¨å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åç›´æ¥ä»æ ˆå½“ä¸­å–å‡ºè¿™ä¸ªå€¼å³å¯ã€‚

__builtin_return_address çš„ç­¾åå¦‚ä¸‹ï¼š

```c
__builtin_return_address(x) // x æ˜¯ä¸€ä¸ªæ•´æ•°
```

å…¶ä¸­ x å’Œå‰é¢çš„ __builtin_frame_address å«ä¹‰ç›¸ä¼¼ï¼š

- x = 0 : è¡¨ç¤ºå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ã€‚
- x = 1 : è¡¨ç¤ºå½“å‰å‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ¯”å¦‚è¯´ main å‡½æ•°è°ƒç”¨ func_a å¦‚æœåœ¨ func_a é‡Œé¢è°ƒç”¨è¿™ä¸ªå†…åµŒæ–¹æ³•ï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯ main å‡½æ•°çš„è¿”å›å€¼ã€‚
- x = 2 : è¡¨ç¤ºå½“å‰å‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€ã€‚

```c

#include <stdio.h>

void func_a()
{
  void* p = __builtin_return_address(0);
  printf("fun_a return address = %p\n", p);

  p = __builtin_return_address(1);
  printf("In func_a main return address = %p\n", p);
}


int main()
{
  void* p = __builtin_return_address(0);
  printf("main return address = %p\n", p);
  func_a();
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºè¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š

```
main return address = 0x7fc5c57c90b3
fun_a return address = 0x400592
In func_a main return address = 0x7fc5c57c90b3
```

ä»ä¸Šé¢çš„è¾“å‡ºç»“æœæˆ‘ä»¬å¯ä»¥çŸ¥é“

### ä½¿ç”¨å†…æ•›æ±‡ç¼–å®ç°

å¦‚æœæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼ˆåœ¨x86é‡Œé¢æ‰§è¡Œ call æŒ‡ä»¤ï¼‰é¦–å…ˆä¼šå°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹æ ˆï¼ˆåœ¨ 32 ä½ç³»ç»Ÿä¸Šå°±æ˜¯å°† eip å‹æ ˆï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šå°±æ˜¯å°† rip å‹æ ˆï¼‰ï¼Œç„¶åå½¢æˆè°ƒç”¨å‡½æ•°çš„æ ˆå¸§ã€‚ç„¶åå°† rbp å¯„å­˜å™¨çš„å€¼æŒ‡å‘ä¸‹å›¾å½“ä¸­çš„ä½ç½®ã€‚

![01](../../images/pl/01.png)

```c

#include <stdio.h>
#include <sys/types.h>

#define return_address            \
    u_int64_t rbp;                \
    asm volatile(                 \
      "movq %%rbp, %0":"=m"(rbp)::\
    );                            \
    printf("From inline assembly return address = %p\n", (u_int64_t*)*(u_int64_t*)(rbp + 8));

void func_a()
{
  printf("In func_a\n");
  void* p = __builtin_return_address(0);
  printf("fun_a return address = %p\n", p);
  return_address
}

int main()
{
  printf("In main function\n");
  void* p = __builtin_return_address(0);
  printf("main return address = %p\n", p);
  return_address
  func_a();
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
In main function
main return address = 0x7fe6a7b050b3
From inline assembly return address = 0x7fe6a7b050b3
In func_a
fun_a return address = 0x4005d2
From inline assembly return address = 0x4005d2
```

ä»ä¸Šé¢çš„è¾“å‡ºç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è‡ªå·±ä½¿ç”¨å†…æ•›æ±‡ç¼–ç›´æ¥å¾—åˆ°å¯„å­˜å™¨ rbp çš„å’Œå†…åµŒå‡½æ•°è¿”å›çš„å€¼æ˜¯ä¸€è‡´çš„ï¼Œè¿™ä¹Ÿä»ä¾§é¢åæ˜ å‡ºæ¥äº†å†…åµŒå‡½æ•°çš„ä½œç”¨ã€‚åœ¨ä¸Šé¢çš„ä»£ç å½“ä¸­å®šä¹‰å®šä¹‰çš„å® return_address çš„ä½œç”¨å°±æ˜¯å°†å¯„å­˜å™¨ rbp çš„å€¼ä¿å­˜åˆ°å˜é‡ rbp å½“ä¸­ã€‚

é™¤äº†å¾—åˆ°å½“å‰æ ˆå¸§çš„ rbp çš„å€¼ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥ï¼Œå‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„ rbpï¼Œè°ƒç”¨å‡½æ•°çš„è°ƒç”¨å‡½æ•°çš„ rbpï¼Œå½“ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ builtin å‡½æ•°å®ç°ï¼Œé™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å†…æ•›æ±‡ç¼–å»å®ç°è¿™ä¸€ç‚¹ï¼š

```c

#include <stdio.h>
#include <sys/types.h>

#define return_address            \
    u_int64_t rbp;                \
    asm volatile(                 \
      "movq %%rbp, %%rcx;"        \
      "movq (%%rcx), %%rcx;"      \
      "movq %%rcx, %0;"           \
      :"=m"(rbp)::"rcx"           \
    );                            \
    printf("From inline assembly main return address = %p\n", (u_int64_t*)*(u_int64_t*)(rbp + 8));

void func_a()
{
  printf(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> In func_a\n");
  void* p = __builtin_return_address(1);
  printf("main return address = %p\n", p);
  return_address
  printf("<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< Out func_a\n");
}


int main()
{
  func_a();
  void* p = __builtin_return_address(0);
  printf("main function return address = %p\n", p);
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º

```c
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> In func_a
main return address = 0x7f9aec6c80b3
From inline assembly main return address = 0x7f9aec6c80b3
<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< Out func_a
main function return address = 0x7f9aec6c80b3
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºï¼Œæˆ‘ä»¬è‡ªå·±ç”¨å†…æ•›æ±‡ç¼–å®ç°çš„ç»“æœå’Œ __builtin_return_address çš„è¿”å›ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¹ŸéªŒè¯äº†æˆ‘ä»¬å®ç°çš„æ­£ç¡®æ€§ã€‚è¦æƒ³ç†è§£ä¸Šé¢çš„ä»£ç é¦–å…ˆæˆ‘ä»¬éœ€è¦ç†è§£å‡½æ•°è°ƒç”¨çš„æ—¶å€™å½¢æˆçš„æ ˆå¸§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![01](../../images/pl/02.png)

æ ¹æ®ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ func_a å‡½æ•°å½“ä¸­ï¼Œrbp æŒ‡å‘çš„åœ°å€å­˜æ”¾çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„ rbp å¯„å­˜å™¨çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é—´æ¥å¯»å€ï¼Œæ‰¾åˆ°è°ƒç”¨ func_a çš„ä¸»å‡½æ•°çš„ rbp çš„å€¼ï¼Œå³ä»¥åœ¨å‡½æ•° func_a å½“ä¸­ rbp å¯„å­˜å™¨çš„å€¼ä¸ºåœ°å€ï¼Œæ‰¾åˆ°è¿™ä¸ªåœ°å€çš„å€¼å°±æ˜¯ä¸»å‡½æ•°çš„ rbp çš„å€¼ã€‚

è‡³æ­¤æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œ__builtin_return_address çš„è¿”å›ç»“æœæ˜¯å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼Œä¹Ÿå°±æ˜¯å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆè¿”å›ä¹‹åæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹åšå‡ºä¸€ä¸ªéå¸¸å¥½ç©çš„ä¸œè¥¿ï¼Œç›´æ¥è·³è½¬åˆ°è¿”å›åœ°å€æ‰§è¡Œä¸æ‰§è¡Œå½“å‰å‡½æ•°çš„åç»­ä»£ç ï¼š

```c

#include <stdio.h>

void func_a()
{
  void* p        = __builtin_return_address(0); // å¾—åˆ°å½“å‰å‡½æ•°çš„è¿”å›åœ°å€
  void* rbp      = __builtin_frame_address(0);  // å¾—åˆ°å½“å‰å‡½æ•°çš„æ ˆå¸§çš„æ ˆåº•
  void* last_rbp = __builtin_frame_address(1);	// å¾—åˆ°è°ƒç”¨å‡½æ•°çš„æ ˆå¸§çš„æ ˆåº•
  asm volatile(
    "leaq 16(%1), %%rsp;" // æ¢å¤ rsp å¯„å­˜å™¨çš„å€¼ â“·
    "movq %2, %%rbp;"     // æ¢å¤ rbp å¯„å­˜å™¨çš„å€¼ â“¸
    "jmp *%0;"            // ç›´æ¥è·³è½¬						â“¹
    ::"r"(p), "r"(rbp), "r"(last_rbp): 
  );
  printf("finished in func_a\n"); // â‘ 
}


int main()
{
  void* p = __builtin_return_address(0);
  printf("main return address = %p\n", p);
  func_a(); // â‘¡
  printf("finished in main function \n");
  // æ‰“å°ä¹ä¹ä¹˜æ³•è¡¨
  int i, j;
  for(i = 1; i < 10; ++i) 
  {
    for(j = 1; j <= i; ++j) {
      printf("%d x %d = %d\t", i, j, i * j);
    }
    printf("\n");
  }
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
main return address = 0x7f63e05c60b3
finished in main function 
1 x 1 = 1
2 x 1 = 2       2 x 2 = 4
3 x 1 = 3       3 x 2 = 6       3 x 3 = 9
4 x 1 = 4       4 x 2 = 8       4 x 3 = 12      4 x 4 = 16
5 x 1 = 5       5 x 2 = 10      5 x 3 = 15      5 x 4 = 20      5 x 5 = 25
6 x 1 = 6       6 x 2 = 12      6 x 3 = 18      6 x 4 = 24      6 x 5 = 30      6 x 6 = 36
7 x 1 = 7       7 x 2 = 14      7 x 3 = 21      7 x 4 = 28      7 x 5 = 35      7 x 6 = 42      7 x 7 = 49
8 x 1 = 8       8 x 2 = 16      8 x 3 = 24      8 x 4 = 32      8 x 5 = 40      8 x 6 = 48      8 x 7 = 56      8 x 8 = 64
9 x 1 = 9       9 x 2 = 18      9 x 3 = 27      9 x 4 = 36      9 x 5 = 45      9 x 6 = 54      9 x 7 = 63      9 x 8 = 72      9 x 9 = 81
```

ä»ä¸Šé¢ç¨‹åºçš„è¾“å‡ºç»“æœæ¥çœ‹ï¼Œä¸Šé¢çš„ç¨‹åºå¹¶æ²¡æœ‰æ‰§è¡Œè¯­å¥ â‘  ï¼Œä½†æ˜¯å´æ‰§è¡Œäº†ä¸»å‡½æ•° â‘¡ ä¹‹åçš„ç¨‹åºï¼Œå¹¶ä¸”æ­£ç¡®è¾“å‡ºå­—ç¬¦ä¸²å’Œä¹ä¹ä¹˜æ³•è¡¨ã€‚è¿™å°±ç›¸å½“äºæˆ‘ä»¬æå‰è¿›è¡Œäº†è·³è½¬ã€‚è¦æƒ³å¾—åˆ°è¿™æ ·çš„ç»“æœï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å‡½æ•° func_a å†…éƒ¨æ¢å¤ä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§ï¼Œå¹¶ä¸”å°† rip æŒ‡å‘å‡½æ•° func_a çš„è¿”å›åœ°å€å³å¯ã€‚

ä¸Šæ–¹çš„ç¨‹åºå‘ç”Ÿè½¬ç§»çš„ä»£ç å°±æ˜¯é‚£æ®µå†…æ•›æ±‡ç¼–ä»£ç ï¼Œåœ¨å†…æ•›æ±‡ç¼–ä»£ç å½“ä¸­æˆ‘ä»¬é¦–å…ˆæ¢å¤ main å‡½æ•°çš„æ ˆå¸§ï¼ˆä¸»è¦æ˜¯æ­£ç¡®æ¢å¤å¯„å­˜å™¨ rbp å’Œ rsp ï¼‰çš„å€¼ï¼Œç„¶åç›´æ¥è·³è½¬åˆ°è¿”å›åœ°å€ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥æ‰æ­£ç¡®æ‰§è¡Œäº†ä¸»å‡½æ•°åç»­çš„ä»£ç ã€‚

æ¢å¤ä¸»å‡½æ•°çš„ rbp å¯„å­˜å™¨çš„å€¼å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦é€šè¿‡å†…åµŒå‡½æ•°ç›´æ¥å¾—åˆ°å³å¯ï¼Œä½†æ˜¯ä¸»å‡½æ•°çš„ rsp å¯„å­˜å™¨çš„å€¼å¯èƒ½æœ‰ä¸€ç‚¹å¤æ‚ï¼Œsé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œä¸»å‡½æ•°å’Œ func_a çš„ä¸¤ä¸ªä¸æ ˆå¸§æœ‰å…³çš„å¯„å­˜å™¨çš„æŒ‡å‘ï¼Œä»–ä»¬çš„æŒ‡å‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![01](../../images/pl/02.png)

- æ ¹æ®ä¸Šæ–‡çš„åˆ†ææˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡åœ¨å‡½æ•° func_a å½“ä¸­ç›´æ¥ä½¿ç”¨ __builtin_frame_address(1) å¾—åˆ°ä¸»å‡½æ•°çš„ rbp å€¼ï¼Œç„¶åå°†å…¶ç›´æ¥èµ‹å€¼ç»™ rbp å¯„å­˜å™¨å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬å°±æ¢å¤äº†ä¸»å‡½æ•°æ ˆåº•çš„å€¼ï¼Œå¯¹åº”çš„è¯­å¥ä½ä¸Šé¢ä»£ç çš„ â“¸ã€‚
- æ ¹æ®ä¸Šæ–‡çš„åˆ†ææˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡åœ¨å‡½æ•° func_a å½“ä¸­ç›´æ¥ä½¿ç”¨ __builtin_return_address(0) å¾—åˆ° func_a çš„è¿”å›åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ jmp åˆ°è¿™æ¡æŒ‡ä»¤æ‰§è¡Œï¼Œä½†æ˜¯åœ¨ jmp ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆæ¢å¤ä¸»å‡½æ•°çš„æ ˆå¸§ï¼Œå¯¹åº”çš„è¯­å¥ä½ä¸Šé¢çš„ â“¹ã€‚
- æ ¹æ®ä¸Šå›¾æˆ‘ä»¬å¯ä»¥åˆ†æåˆ°ä¸»å‡½æ•° rsp çš„å€¼å°±æ˜¯å‡½æ•° func_a ä¸­ rbp å¯„å­˜å™¨çš„å€¼åŠ ä¸Š 16ï¼Œå› ä¸º rip å’Œ rbp åˆ†åˆ«å  8 ä¸ªå­—èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ â“· æ¢å¤ä¸»å‡½æ•°çš„ rsp çš„å€¼ã€‚

æ ¹æ®ä¸Šé¢çš„åˆ†ææˆ‘å°±å¤§è‡´å°±å¯ä»¥ç†è§£äº†ä¸Šè¿°çš„ä»£ç çš„æµç¨‹äº†ã€‚

## ä¸äºŒè¿›åˆ¶ç›¸å…³çš„å†…åµŒå‡½æ•°

### __builtin_popcount 

åœ¨ gcc å†…éƒ¨ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šç”¨äºæ¯”ç‰¹æ“ä½œçš„å†…åµŒå‡½æ•°ï¼Œæ¯”å¦‚è¯´å¦‚æœæˆ‘ä»¬æƒ³ç»Ÿè®¡ä¸€ä¸‹ä¸€ä¸ªæ•°æ®äºŒè¿›åˆ¶è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªä¸º 1 çš„æ¯”ç‰¹ä½ã€‚

- __builtin_popcount :  ç»Ÿè®¡ä¸€ä¸ªæ•°æ®çš„äºŒè¿›åˆ¶è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªä¸º 1 çš„æ¯”ç‰¹ä½ã€‚

```c
#include <stdio.h>

int main()
{
  int i = -1;
  printf("bits = %d\n", __builtin_popcount(i));
  i = 15;
  printf("bits = %d\n", __builtin_popcount(i));
  return 0;
}
```

ä¸Šé¢ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
bits = 32
bits = 4
```

-1 å’Œ 15 çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¦‚ä¸‹ï¼š

```c
-1 = 1111_1111_1111_1111_1111_1111_1111_1111
15 = 0000_0000_0000_0000_0000_0000_0000_1111
```

å› æ­¤ç»Ÿè®¡ä¸€ä¸‹å¯¹åº”æ•°å­—çš„æ¯”ç‰¹ä½ç­‰äº 1 çš„ä¸ªæ•°å¯ä»¥çŸ¥é“ï¼Œå†…åµŒå‡½æ•° __builtin_popcount çš„è¾“å‡ºç»“æœæ˜¯æ²¡é”™çš„ã€‚

-  \_\_builtin_popcountl å’Œ \_\_builtin_popcountlï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨å’Œ __builtin_popcount çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯ç”¨äº long å’Œ long long ç±»å‹çš„å‚æ•°ã€‚

### __builtin_ctz

- __builtin_ctz : ä»å³å¾€å·¦æ•°ï¼Œç»Ÿè®¡ä¸€ä¸ªæ•°æ®å°¾éƒ¨æ¯”ç‰¹ä½ç­‰äº 0 çš„ä¸ªæ•°ï¼Œå…·ä½“æ˜¯åœ¨é‡åˆ°ç¬¬ä¸€ä¸ª 1 ä¹‹å‰ï¼Œå·²ç»é‡åˆ°äº†å‡ ä¸ª 1 ã€‚

```c
#include <stdio.h>

int main()
{
  printf("%d\n", __builtin_ctz(1)); // ctz = count trailing zeros. 
  printf("%d\n", __builtin_ctz(2));
  printf("%d\n", __builtin_ctz(3));
  printf("%d\n", __builtin_ctz(4));
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
0
1
0
2
```

1ï¼Œ2ï¼Œ3ï¼Œ4 å¯¹åº”çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
1 = 0000_0000_0000_0000_0000_0000_0000_0001 // åˆ°ç¬¬ä¸€ä¸ª 1 ä¹‹å‰ æœ‰ 0 ä¸ª 0
2 = 0000_0000_0000_0000_0000_0000_0000_0010 // åˆ°ç¬¬ä¸€ä¸ª 1 ä¹‹å‰ æœ‰ 0 ä¸ª 1
3 = 0000_0000_0000_0000_0000_0000_0000_0011 // åˆ°ç¬¬ä¸€ä¸ª 1 ä¹‹å‰ æœ‰ 0 ä¸ª 0
4 = 0000_0000_0000_0000_0000_0000_0000_0100 // åˆ°ç¬¬ä¸€ä¸ª 1 ä¹‹å‰ æœ‰ 0 ä¸ª 2
```

æ ¹æ®ä¸Šé¢ä¸åŒæ•°æ®çš„äºŒè¿›åˆ¶è¡¨ç¤ºä»¥åŠä¸Šæ–¹ç¨‹åºçš„è¾“å‡ºç»“æœå¯ä»¥çŸ¥é“ __builtin_ctz çš„è¾“å‡ºå°±æ˜¯å°¾éƒ¨ç­‰äº 0 çš„ä¸ªæ•°ã€‚

- \_\_builtin_ctzl å’Œ \_\_builtin_ctzll ä¸ __builtin_ctz çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯ç”¨äº long å’Œ long long ç±»å‹çš„æ•°æ®ã€‚

ä¸Šé¢è°ˆåˆ°çš„ __builtin_ctz è¿™ä¸ªå†…åµŒå‡½æ•°æˆ‘ä»¬å¯ä»¥ç”¨äºæ±‚ä¸€ä¸ªæ•°æ®çš„ lowbit çš„å€¼ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªæ•°æ®çš„ lowbit å°±æ˜¯æœ€ä½ä½çš„æ¯”ç‰¹æ‰€è¡¨ç¤ºçš„æ•°æ®ï¼Œä»–çš„æ±‚è§£å‡½æ•°å¦‚ä¸‹ï¼š

```c
int lowbit(int x)
{
  return (x) & (-x);
}
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šé¢çš„å†…åµŒå‡½æ•°å»å®ç°ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„å†…åµŒå‡½æ•°å®šä¹‰ä¸€ä¸ªå®å»å®ç° lowbitï¼š

```c
#include <stdio.h>

#define lowbit(x) (1 << (__builtin_ctz(x)))

int lowbit(int x)
{
  return (x) & (-x);
}

int main()
{
  for(int i = 0; i < 16; ++i)
  {
    printf("macro = %d function = %d\n", lowbit(i), lowbit2(i));
  }
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
macro = 1 function = 0
macro = 1 function = 1
macro = 2 function = 2
macro = 1 function = 1
macro = 4 function = 4
macro = 1 function = 1
macro = 2 function = 2
macro = 1 function = 1
macro = 8 function = 8
macro = 1 function = 1
macro = 2 function = 2
macro = 1 function = 1
macro = 4 function = 4
macro = 1 function = 1
macro = 2 function = 2
macro = 1 function = 1
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨å†…åµŒå‡½æ•°å’Œè‡ªå·±å®šä¹‰çš„ lowbit å‡½æ•°å®ç°çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚

### __builtin_clz

è¿™ä¸ªæ˜¯ç”¨äºç»Ÿè®¡ä¸€ä¸ªæ•°æ®çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œä»å·¦å¾€å³æ•°é‡åˆ°ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½ç­‰äº 1 ä¹‹å‰å·²ç»é‡åˆ°äº†å¤šå°‘ä¸ª 0ã€‚

```c

#include <stdio.h>

int main()
{
  for(int i = 1; i < 16; ++i) 
  {
    printf("i = %2d and result = %2d\n", i, __builtin_clz(i));
  }
  printf("i = %2d and result = %2d\n", -1, __builtin_clz(-1));
  return 0;
}
```

ä¸Šé¢çš„ç¨‹åºè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```c
i =  1 and result = 31 // é«˜ä½æœ‰ 31 ä¸ª 0
i =  2 and result = 30 // é«˜ä½æœ‰ 30 ä¸ª 0
i =  3 and result = 30
i =  4 and result = 29
i =  5 and result = 29
i =  6 and result = 29
i =  7 and result = 29
i =  8 and result = 28
i =  9 and result = 28
i = 10 and result = 28
i = 11 and result = 28
i = 12 and result = 28
i = 13 and result = 28
i = 14 and result = 28
i = 15 and result = 28
i = -1 and result =  0 // é«˜ä½æ²¡æœ‰ 0
```

æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„æ•°æ® i å¯¹åº”ä»–çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå°±å¯ä»¥çŸ¥é“ä»å·¦å¾€å³æ•°é‡åˆ°ç¬¬ä¸€ä¸ªç­‰äº 1 çš„æ¯”ç‰¹ä½ä¹‹å‰ä¼šæœ‰å¤šå°‘ä¸ª 0 ï¼Œæˆ‘ä»¬æ‹¿ -1 è¿›è¡Œåˆ†æï¼Œå› ä¸ºåœ¨è®¡ç®—æœºå½“ä¸­æ•°æ®çš„éƒ½æ˜¯ä½¿ç”¨è¡¥ç è¿›è¡Œè¡¨ç¤ºï¼Œè€Œ -1 çš„è¡¥ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
-1 = 1111_1111_1111_1111_1111_1111_1111_1111
```

å› æ­¤ é«˜ä½æ²¡æœ‰ 0ï¼Œæ‰€ä»¥è¿”å›çš„ç»“æœç­‰äº 0ã€‚

## æ€»ç»“

åœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ä¸»è¦ç»™å¤§å®¶ä»‹ç»ä¸€äº›åœ¨ gcc å½“ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„å†…åµŒå‡½æ•°ï¼Œå¤§å®¶å¯ä»¥ç©ä¸€ä¸‹ï½ï½ï½ï½ğŸ˜‚

---

æ›´å¤šç²¾å½©å†…å®¹åˆé›†å¯è®¿é—®é¡¹ç›®ï¼š<https://github.com/Chang-LeHung/CSCore>

å…³æ³¨å…¬ä¼—å·ï¼šä¸€æ— æ˜¯å¤„çš„ç ”ç©¶åƒ§ï¼Œäº†è§£æ›´å¤šè®¡ç®—æœºï¼ˆJavaã€Pythonã€è®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€ç®—æ³•ä¸æ•°æ®ç»“æ„ï¼‰çŸ¥è¯†ã€‚

![](../../qrcode2.jpg)

